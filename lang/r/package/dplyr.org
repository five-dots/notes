#+STARTUP: folded indent inlineimages latexpreview
#+PROPERTY: header-args:R :results value :colnames yes :session *R:dplyr*

* Load library and check version

#+begin_src R :results silent
library(dplyr)
#+end_src

- バージョンの確認

#+begin_src R :results output :exports both
packageVersion("dplyr")
#+end_src

#+RESULTS:
: [1] ‘0.8.3’

- 関数の収録数
#+begin_src R :results output :exports both
length(ls("package:dplyr"))
#+end_src

#+RESULTS:
: [1] 267

* Dataset

- ~{tidyquant}~ に収録されている ~FANG~ データセットを利用する
- Facebook, Amazon, Netflix, Goolge の株価データ

#+begin_src R :results value :colnames yes
library(tidyquant)
data(FANG)
# 表示を見やすくするために、小数点以下第二位までにしておく
FANG <- FANG %>% mutate_if(is.numeric, round, digit = 2)
head(FANG, n = 3)
#+end_src

#+RESULTS:
| symbol |       date |  open |  high |   low | close |   volume | adjusted |
|--------+------------+-------+-------+-------+-------+----------+----------|
| FB     | 2013-01-02 | 27.44 | 28.18 | 27.42 |    28 | 69846400 |       28 |
| FB     | 2013-01-03 | 27.88 | 28.47 | 27.59 | 27.77 | 63140600 |    27.77 |
| FB     | 2013-01-04 | 28.01 | 28.93 | 27.83 | 28.76 | 72715400 |    28.76 |
\\

* One ~data.frame~ functions
** Manipulate rows
*** ~filter()~

- 条件に合致する行を抽出

#+begin_src R
FANG %>% filter(symbol == "GOOG" & date == "2013-01-02")
#+end_src

#+RESULTS:
| symbol |       date |   open | high |    low |  close |  volume | adjusted |
|--------+------------+--------+------+--------+--------+---------+----------|
| GOOG   | 2013-01-02 | 719.42 |  727 | 716.55 | 723.25 | 5101500 |   361.26 |
\\

- AND 条件は、「,」で繋げて書くことができる
#+begin_src R
FANG %>% filter(symbol == "GOOG", date == "2013-01-02")
#+end_src

#+RESULTS:
| symbol |       date |   open | high |    low |  close |  volume | adjusted |
|--------+------------+--------+------+--------+--------+---------+----------|
| GOOG   | 2013-01-02 | 719.42 |  727 | 716.55 | 723.25 | 5101500 |   361.26 |
\\

- GlobalEnv に存在する変数でフィルタしようとするとうまくいかない
- ~.GlobalEnv$symbol~ ではなく ~.data$symbol~ が使われてしまうため
- ~.data~ は *pronoun* (=代名詞) と呼ばれ ~{dplyr}~ の関数に渡された ~data.frame~ 自体を参照できる

#+begin_src R
symbol = "GOOG"
FANG %>% filter(symbol == symbol, .data$date == "2013-01-02")
#+end_src

#+RESULTS:
| symbol |       date |   open |  high |    low |  close |   volume | adjusted |
|--------+------------+--------+-------+--------+--------+----------+----------|
| FB     | 2013-01-02 |  27.44 | 28.18 |  27.42 |     28 | 69846400 |       28 |
| AMZN   | 2013-01-02 | 256.08 | 258.1 | 253.26 | 257.31 |  3271000 |   257.31 |
| NFLX   | 2013-01-02 |  95.21 | 95.81 |  90.69 |  92.01 | 19431300 |    13.14 |
| GOOG   | 2013-01-02 | 719.42 |   727 | 716.55 | 723.25 |  5101500 |   361.26 |
\\

- 対策としては、3つ存在する
  1. .GlobalEnv を指定する
  2. unquote(~!!~) する
  3. ~rlang::syms()~ でシンボル化した後に、unquote-splicing(~!!!~) する

#+begin_src R
symbol = "GOOG"
## 方法1
FANG %>% filter(symbol == .GlobalEnv$symbol, .data$date == "2013-01-02")

## 方法2 （結果は同じ)
## FANG %>% filter(symbol == !!symbol, .data$date == "2013-01-02")

## 方法3 （結果は同じ)
## FANG %>% filter(symbol == !!!rlang::syms(symbol), .data$date == "2013-01-02")
#+end_src

#+RESULTS:
| symbol |       date |   open | high |    low |  close |  volume | adjusted |
|--------+------------+--------+------+--------+--------+---------+----------|
| GOOG   | 2013-01-02 | 719.42 |  727 | 716.55 | 723.25 | 5101500 |   361.26 |
\\

**** ~distinct()~
*** Summarise rows
*** Group rows
** Manipulate variables
** Manipulate groups
* Two ~data.frame~ functions
** Set Operations
** Join Operations
* Helper functions
** Vector Functions
** Summary Functions
* DB functions
* Imported functions
* Deprecated functions
* Session info

#+begin_src R :results output :exports both
sessionInfo()
#+end_src

#+RESULTS:
#+begin_example
R version 3.6.1 (2019-07-05)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.7.1

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] rlang_0.4.0                tidyquant_0.5.7           
[3] quantmod_0.4-15            TTR_0.23-5                
[5] PerformanceAnalytics_1.5.3 xts_0.11-2                
[7] zoo_1.8-6                  lubridate_1.7.4           
[9] dplyr_0.8.3               

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.2       rstudioapi_0.10  magrittr_1.5     tidyselect_0.2.5
 [5] lattice_0.20-38  R6_2.4.0         quadprog_1.5-7   fansi_0.4.0     
 [9] httr_1.4.1       stringr_1.4.0    tools_3.6.1      grid_3.6.1      
[13] utf8_1.1.4       cli_1.1.0        assertthat_0.2.1 tibble_2.1.3    
[17] crayon_1.3.4     purrr_0.3.2      vctrs_0.2.0      zeallot_0.1.0   
[21] curl_3.3         Quandl_2.10.0    glue_1.3.1       stringi_1.4.3   
[25] compiler_3.6.1   pillar_1.4.2     backports_1.1.5  jsonlite_1.6    
[29] pkgconfig_2.0.3
#+end_example

* Reference

- [[https://dplyr.tidyverse.org/][公式サイト]]
- [[https://cran.r-project.org/web/packages/dplyr/index.html][CRAN]]
- [[https://github.com/tidyverse/dplyr][github repo]]
- [[https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf][Cheatsheet(PDF)]]
- [[https://heavywatal.github.io/rstats/dplyr.html][dplyr — 高速data.frame処理]]
- [[https://dplyr.tidyverse.org/reference/se-deprecated.html][Deprecated SE versions of main verbs.]]
- [[https://notchained.hatenablog.com/entry/2017/03/24/225154][メモ：dplyr が Standard evaluation を deprecated にしようとしている理由]]
- [[https://notchained.hatenablog.com/entry/2017/11/15/212117][do()とかrowwise()は今から覚える必要はない（たぶん）]]
- [[https://cran.r-project.org/web/packages/dplyr/dplyr.pdf][Reference Manual]]
- Vignette
  - [[https://cran.r-project.org/web/packages/dplyr/vignettes/compatibility.html][dplyr compatibility]]
  - [[https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html][Introduction to dplyr]] ([[https://qiita.com/yutannihilation/items/7a78d897810446dd6a3b][和訳@Qiita]])
  - [[https://cran.r-project.org/web/packages/dplyr/vignettes/programming.html][Programming with dplyr]]
  - [[https://cran.r-project.org/web/packages/dplyr/vignettes/two-table.html][Two-table verbs]]
  - [[https://cran.r-project.org/web/packages/dplyr/vignettes/window-functions.html][Window functions]]

